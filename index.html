<!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Bombs Away</title>
        <style>
            * {
                margin: 0px;
                padding: 0px;
            }
            body {
                background-color: #2c3e50;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>    
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <script>
            var stompClient = null;
            var idJugador = null;

            function setConnected(connected) {
                console.log('paso por el setConnected');
                $("#connect").prop("disabled", connected);
                $("#disconnect").prop("disabled", !connected);
                if (connected) {
                    $("#conversation").show();
                }
                else {
                    $("#conversation").hide();
                }
                $("#userinfo").html("");
            }
            async function connect(action) {
                console.log('entro al connect!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!');
                var socket = new SockJS('http://localhost:8091/bombs-away');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, async function (frame) {
                    setConnected(true);
                    console.log('Connected: ' + frame);
                    stompClient.subscribe('/topic/user', function (greeting) {
                        /*console.log('consoles de CECI', greeting);
                        showGreeting(greeting.body);*/
                    });
                    action;
                });
            }

            function disconnect() {
                if (stompClient !== null) {
                    stompClient.disconnect();
                }
                setConnected(false);
                console.log("Disconnected");
            }

            function crearPartidaEnEspera() {
                //establezco la conexion y especifico la funcion a ejecutar una vez finalizada la conexion
                var socket = new SockJS('http://localhost:8091/bombs-away');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function (frame) {
                    setConnected(true);
                    console.log('Connected: ' + frame);
                    //me subscribo al canal de datos
                    stompClient.subscribe('/topic/user', function (greeting) {
                        console.log('consoles de CECI', greeting);
                        showGreeting(greeting.body);
                        return;
                    });
                    //solicito la creacion de una nueva partida
                    stompClient.send("/app/nueva-partida", {}, JSON.stringify({
                        'nombrePartida': 'PartidaPrueba',
                        'nombreJugador': 'Fede',
                    }));
                    idJugador = 1;
                });
            }

            function unirseAPartida() {
                var socket = new SockJS('http://localhost:8091/bombs-away');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function (frame) {
                    setConnected(true);
                    console.log('Connected: ' + frame);
                    //me subscribo al canal de datos
                    stompClient.subscribe('/topic/user', function (greeting) {
                        console.log('consoles de CECI', greeting);
                        showGreeting(greeting.body);
                    });
                    //solicito unirme a una partida
                    stompClient.send("/app/unirse-a-partida", {}, JSON.stringify({
                        'nombreJugador': $("#nombreJugadorUnirse").val(),
                    }));
                });
                idJugador = 2;
            }

            function moverAvion(x,y,angle) {
                stompClient.send("/app/mover-avion", {}, JSON.stringify({
                    'nombrePartida': 'La mejor partida',
                    'idJugador': idJugador,
                    'id': 1,
                    'ejeX': x,
                    'ejeY': y,
                    'angulo': angle,
                }));
            }



            function sendName() {
                stompClient.send("/app/user", {}, JSON.stringify({ 'name': $("#name").val() }));
            }

            function showGreeting(message) {
                $("#userinfo").append("<tr><td>" + message + "</td></tr>");
            }

            $(function () {
                $("form").on('submit', function (e) {
                    e.preventDefault();
                });
                // $("#connect").click(function () { connect(); });
                // $("#disconnect").click(function () { disconnect(); });
                $("#send").click(function () { sendName(); });
                $("#moverAvion").click(function () { moverAvion(); });
                $("#crearPartida").click(function () { crearPartidaEnEspera(); });
                $("#unirsePartida").click(function () { unirseAPartida(); });
            });
        </script>
    </head>
    <body>
        <div id="phaser_container">
            
        </div>        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script> 
        <script src="./node_modules/phaser/dist/phaser.min.js"></script>
        <script src="./src/main.js" type="module"></script>
    </body>
    </html>